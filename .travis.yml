# Copyright (C) 2020 Julian Valentin, LTeX Development Community
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

os: "linux"
dist: "bionic"
language: "ruby"
rvm: "2.7"
before_install:
  - "if [ \"$TRAVIS_BRANCH\" == \"gh-pages-release\" ]; then openssl aes-256-cbc -K $encrypted_30e851d6214e_key -iv $encrypted_30e851d6214e_iv -in github.key.enc -out github.key -d && chmod 600 github.key && eval \"$(ssh-agent)\" && ssh-add github.key; fi"
install:
  # - Cartopy from Ubuntu packages fails due to missing images
  # - Build Shapely from source due to assertion error (https://stackoverflow.com/a/60126085)
  - "if [ \"$TRAVIS_BRANCH\" == \"gh-pages-release\" ]; then sudo apt-get -y install libgeos-dev libproj-dev python3-matplotlib python3-pip python3-scipy python3-setuptools python3-wheel python3-yaml && pip3 install bokeh cartopy && pip3 uninstall -y shapely && pip3 install shapely --no-binary shapely; fi"
  - "bundle install --jobs=3"
script:
  # exit on error
  - "set -e"
  - "if [ \"$TRAVIS_BRANCH\" == \"gh-pages-release\" ]; then git remote set-branches --add origin gh-pages && git fetch origin gh-pages:gh-pages && git checkout gh-pages && git reset --hard gh-pages-release && wget -O _data/stats/stats.json https://github.com/valentjn/vscode-ltex-stats/raw/master/data/stats.json && wget -O _data/stats/map.json https://github.com/valentjn/vscode-ltex-stats/raw/master/data/map.json && python3 tools/plotStats.py; fi"
  - "bundle exec jekyll build"
  - "if [ \"$TRAVIS_BRANCH\" == \"gh-pages-release\" ]; then python3 tools/pushPlottedStats.py; fi"
branches:
  only:
    # build all branches except gh-pages
    - "/^(?!gh-pages$).*$/"
